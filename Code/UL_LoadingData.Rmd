---
title: "UtahLake_WatershedLoading"
author: "Kateri Salk"
date: "5/3/2021"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(viridis)
library(wqTools)
library(sf)
library(cowplot)

theme_set(theme_classic())
options(scipen = 4)
```

```{r}
unmonitored_loading <- read.csv("./UnmonitoredWS_Modeling/MapMyWatershed/Compiled_Model_Results/water_quality_load_summary.csv")
unmonitored_hydrology <- read.csv("./UnmonitoredWS_Modeling/MapMyWatershed/Compiled_Model_Results/hydrology.csv")

monitored_loading <- read.csv("./Data/Processed/loading_AllWatersheds_annual.csv")

# watershed spatial data
wshds <- read_sf("./Data/GIS/UL_subwshedsWGS84_v2.shp")
```

```{r}

unmonitored_loading$Total.Nitrogen <- as.numeric(gsub(",", "", unmonitored_loading$Total.Nitrogen))
unmonitored_loading$Total.Phosphorus <- as.numeric(gsub(",", "", unmonitored_loading$Total.Phosphorus))
unmonitored_loading$WS_Name <- as.factor(unmonitored_loading$WS_Name)
unmonitored_loading$WS_Name <- gsub("_", " ", unmonitored_loading$WS_Name)
unmonitored_loading$WS_Name <- gsub("   ", " - ", unmonitored_loading$WS_Name)
unmonitored_loading$WS_Name[unmonitored_loading$WS_Name == "Lake Mountain -  Gravel Pit"] <- "Lake Mountain  - Gravel Pit"

unmonitored_loading_processed <- unmonitored_loading %>%
  filter(Sources == "Total Loads (kg)") %>%
  mutate(load.TN.tonyr = Total.Nitrogen/1000, 
         load.TP.tonyr = Total.Phosphorus/1000, 
         Flow.cfs = NA, 
         load.TDN.tonyr = NA, 
         load.TDP.tonyr = NA, 
         load.TOC.tonyr = NA,
         load.DOC.tonyr = NA) %>%
  select(WS_Name, Flow.cfs, load.TN.tonyr, load.TDN.tonyr, 
         load.TP.tonyr, load.TDP.tonyr, load.TOC.tonyr, load.DOC.tonyr)
  
unmonitored_hydrology$WS_Name <- as.factor(unmonitored_hydrology$WS_Name)
unmonitored_hydrology$WS_Name <- gsub("_", " ", unmonitored_hydrology$WS_Name)
unmonitored_hydrology$WS_Name <- gsub("   ", " - ", unmonitored_hydrology$WS_Name)
unmonitored_hydrology$WS_Name[unmonitored_hydrology$WS_Name == "Lake Mountain -  Gravel Pit"] <- "Lake Mountain  - Gravel Pit"

wshds_area <- wshds %>%
  select(WS_Name, wsa_sqkm)

unmonitored_hydrology_processed <- unmonitored_hydrology %>%
  mutate(Month = match(Month, month.abb)) %>%
  drop_na(Month) %>%
  mutate(Flow.cm = Stream.Flow..cm. + Surface.Runoff..cm. + Point.Src.Flow..cm.) %>%
  select(WS_Name, Month, Flow.cm)

unmonitored_hydrology_processed_annual <- unmonitored_hydrology_processed %>%
  group_by(WS_Name) %>%
  summarise(Flow.cm = sum(Flow.cm)) %>%
  left_join(., wshds_area) %>%
  mutate(Flow.acftyr = Flow.cm * wsa_sqkm * 247.105/30.48)



```

```{r}
loading <- rbind(monitored_loading, unmonitored_loading_processed)
```

```{r}
flow_unmonitored <- unmonitored_hydrology_processed_annual %>%
  select(WS_Name, Flow.acftyr)
flow_monitored <- monitored_loading %>%
  select(WS_Name, Flow.acftyr)
flow <- rbind(flow_unmonitored, flow_monitored)

flow_total <- flow %>%
  summarise(Flow.acft.yr = sum(Flow.acftyr))

#compare to Su and Von Stackelberg: 
147729+209013  

```

```{r}
wshds_loading <- wshds %>%
  left_join(., loading)
```

```{r}
ggplot(wshds_loading) +
  geom_sf(aes(fill = load.TN.tonyr, color = Monitored_)) +
  scale_fill_viridis_c(option = "magma", direction = -1, begin = 0.4) +
  scale_color_manual(values = c("lightgray", "black"))

ggplot(wshds_loading) +
  geom_sf(aes(fill = load.TP.tonyr, color = Monitored_)) +
  scale_fill_viridis_c(option = "magma", direction = -1, begin = 0.4) +
  scale_color_manual(values = c("lightgray", "black")) +
  labs(fill = "TP load", color = "Monitored") +
  theme(legend.position = "top")
ggsave(file = "./Code/Output/TPloadmap.jpg", width = 5, height = 6)
```

