---
title: "UtahLake_TributaryData"
author: "Kateri Salk"
date: "11/24/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(viridis)
library(wqTools)
library(sf)
library(tmap)

theme_set(theme_classic())
```

## Details


## Load data
```{r}
trib <- read.csv("./Data/Processed/ul_Tribdata_wqp_processed.csv")
fac <- read.csv("./Data/Processed/ul_Facilitydata_wqp_processed.csv")
wshds <- read_sf("./Data/GIS/ulSubWshdsWGS84.shp")

#siteID <- read.csv("./Data/Processed/LUT.MLID.csv")
```

## Process data

### Watersheds

```{r}
wshds_monitored <- wshds %>%
  filter(Monitored_ == "YES")
```


### Tributary data

1. Find rows in dataset with C, N, or P data
2. Clean up rows and columns
3. Use only data from 2015-present
4. Pivot to wide format

```{r}
trib$datetime <- as.POSIXct(trib$datetime)
#unique(trib$CharacteristicName)
trib$ResultMeasureValue <- as.numeric(trib$ResultMeasureValue)

trib_wq <- trib %>%
  filter(CharacteristicName %in% 
           c("Ammonia-nitrogen as N", "Carbon", "Nitrate as N", "Organic carbon",
             "Ammonium", "Carbonate", "Inorganic carbon", "Nitrate", "Nitrogen", 
             "Phosphorus", "Ammonia and ammonium", 
             "Inorganic nitrogen (nitrate and nitrite)", "Nitrite", "Orthophosphate", 
             "Kjeldahl nitrogen", "Nitrogen, mixed forms (NH3), (NH4), organic, (NO2) and (NO3)",
             "Organic Nitrogen", "Ammonia-nitrogen", "Phosphate-phosphorus",
             "Total Kjeldahl nitrogen")) %>%
  filter(ResultMeasure.MeasureUnitCode %in% c("ueq/L", "mg/l", "mg/l as N", "<NA>", "mg/l as P")) %>%
  select(MonitoringLocationIdentifier:LongitudeMeasure, ResultMeasureValue, ResultMeasure.MeasureUnitCode) %>%
  mutate(Month = month(datetime), 
         Year = year(datetime)) %>%
  filter(Year >= 2015) %>%
  droplevels() %>%
  filter(!is.na(ResultMeasureValue)) %>%
  select(-SampleDepthValue, -RelativeDepth, -ResultMeasure.MeasureUnitCode) %>%
  unite("Variable", CharacteristicName:ResultSampleFractionText) 

trib_flow <- trib %>%
  filter(CharacteristicName == "Flow") %>%
           #c("Height, gage", "Stream flow, instantaneous", "Stream flow, mean. daily")) %>%
  droplevels() %>%
  filter(!is.na(datetime), 
         ResultStatusIdentifier != "Provisional") %>%
  select(MonitoringLocationIdentifier:LongitudeMeasure, ResultMeasureValue, ResultMeasure.MeasureUnitCode) %>%
  select(-SampleDepthValue, -RelativeDepth, -ResultSampleFractionText, 
         -MonitoringLocationTypeName, -CharacteristicName) %>%
  #mutate(date = date(datetime)) %>%
  group_by(MonitoringLocationIdentifier, datetime, OrganizationIdentifier, 
           OrganizationFormalName, MonitoringLocationName,
           LatitudeMeasure, LongitudeMeasure, ResultMeasure.MeasureUnitCode) %>%
  summarise(ResultMeasureValue = mean(ResultMeasureValue)) %>%
  pivot_wider(names_from = ResultMeasure.MeasureUnitCode, values_from = ResultMeasureValue)

colnames(trib_flow)[8:12] <- c("cfs", "gal.min", "mgd", "g.min", "m3.sec")

# convert everything to cfs
trib_flow$gal.min <- trib_flow$gal.min*0.002228017
trib_flow$mgd <- trib_flow$mgd/64317
trib_flow$g.min <- trib_flow$g.min*0.002228017
trib_flow$m3.sec <- trib_flow$m3.sec*35.3147

# trib_flow$cfs[is.na(trib_flow$cfs)] <- trib_flow$gal.min*0.002228017[is.na(trib_flow$cfs)]

ggplot(trib_flow, aes(x = datetime)) +
  geom_point(aes(y = cfs)) +
  geom_point(aes(y = gal.min), color = "blue") +
  geom_point(aes(y = mgd), color = "red") +
  geom_point(aes(y = g.min), color = "purple") +
  geom_point(aes(y = m3.sec), color = "gray") +
  scale_y_log10()

#test <- left_join(trib_fac_sites_intersect_downstream, trib_flow) 
```


### Facility data

```{r}
fac$datetime <- as.POSIXct(fac$datetime)
#unique(fac$CharacteristicName)

fac_wq <- fac %>%
  filter(CharacteristicName %in% 
           c("Ammonia-nitrogen as N", "Carbon", "Nitrate as N", "Organic carbon",
             "Ammonium", "Carbonate", "Inorganic carbon", "Nitrate", "Nitrogen", 
             "Phosphorus", "Ammonia and ammonium", 
             "Inorganic nitrogen (nitrate and nitrite)", "Nitrite", "Orthophosphate", 
             "Kjeldahl nitrogen", "Nitrogen, mixed forms (NH3), (NH4), organic, (NO2) and (NO3)",
             "Organic Nitrogen", "Ammonia-nitrogen", "Phosphate-phosphorus",
             "Total Kjeldahl nitrogen")) %>%
  filter(ResultMeasure.MeasureUnitCode %in% c("ueq/L", "mg/l", "mg/l as N", "<NA>", "mg/l as P")) %>%
  select(MonitoringLocationIdentifier:LongitudeMeasure, ResultMeasureValue, ResultMeasure.MeasureUnitCode) %>%
  mutate(Month = month(datetime), 
         Year = year(datetime)) %>%
  filter(Year >= 2015) %>%
  droplevels() %>%
  filter(!is.na(ResultMeasureValue)) %>%
  select(-SampleDepthValue, -RelativeDepth, -ResultMeasure.MeasureUnitCode) %>%
  unite("Variable", CharacteristicName:ResultSampleFractionText) 

```

### Combine trib and fac data
```{r, message = FALSE}
trib_fac_wq <- rbind(trib_wq, fac_wq)
  
trib_fac_wq <- trib_fac_wq %>%
  group_by(MonitoringLocationIdentifier, datetime, OrganizationIdentifier,
           OrganizationFormalName, MonitoringLocationName, MonitoringLocationTypeName,
           LatitudeMeasure, LongitudeMeasure, Month, Year, Variable) %>%
  summarise(ResultMeasureValue = mean(ResultMeasureValue, na.rm = TRUE)) %>%
  pivot_wider(names_from = Variable, values_from = ResultMeasureValue)

#colnames(trib_fac_wq)

# .d indicates dissolved, .t indicates total.
colnames(trib_fac_wq)[11:26] <- c("NH3.t", "NO23.d", "NO23.t", "TDN", "TN", "DOC", 
                              "TOC", "TDP", "TP", "NH3.d", "PO4",
                              "NO3.t", "CO3.t", "TKN.d", "NO2.t", "TKN.t")

# some variables represent the same thing. Fill in NAs from other columns.
summary(trib_fac_wq)

```

## Create spatial datasets for trib and fac datasets

1. Intersect stations with watersheds
2. Join water quality data with intersected dataset
3. If a station is not associated with a watershed, assign it
4. Determine downstream stations in watersheds

```{r, message = FALSE, warning = FALSE}

trib_fac_sites <- trib_fac_wq %>% 
  ungroup() %>%
  select(MonitoringLocationIdentifier, MonitoringLocationName, 
           MonitoringLocationTypeName, LatitudeMeasure, LongitudeMeasure) %>%
  distinct() %>%
  mutate(SiteType = ifelse(MonitoringLocationTypeName %in% 
                  c("Canal Drainage", "Canal Irrigation", "Canal Transport"), "Canal", 
                ifelse(MonitoringLocationTypeName %in% c("River/Stream", "Stream", "Stream: Ditch"), "Stream",
                       ifelse(MonitoringLocationTypeName %in% c("Facility Industrial", "Facility Other"), "Facility", 
                              "Storm Sewer"))))


trib_fac_sites_sf <- st_as_sf(trib_fac_sites, coords = c("LongitudeMeasure", "LatitudeMeasure"),
                              crs = 4326, dim = "XY") #CRS = WGS84


trib_fac_sites_intersect <- trib_fac_sites_sf %>%
  st_intersection(wshds) %>%
  left_join(trib_fac_wq, .,) 

unique(trib_fac_sites_intersect$MonitoringLocationName[is.na(trib_fac_sites_intersect$WS_Name)])
unique(trib_fac_sites_intersect$MonitoringLocationIdentifier[is.na(trib_fac_sites_intersect$WS_Name)])
unique(trib_fac_sites_intersect$WS_Name)

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Powell Slough WMA North Outfall to Utah Lake"] <- "Powell Slough Major"

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Powell Slough WMA South Outfall to Utah Lake"] <- "Powell Slough Major"

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Dry Ck Near Utah Lake-WLA"] <- "Dry Creek - Spanish Fork"

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Mill Race at mouth 1.25 miles west of I-15"] <- "Mill Race"  

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Hobble Creek at Utah Lake mouth"] <- "Hobble Creek"
                                 
trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Beer Creek at Utah Lake mouth"] <- "Benjamin Slough"

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Lindon Drain at Utah Lake Inlet"] <- "Lindon Drain"

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Timpanogos WWTP at Utah Lake mouth"] <- "Timp SSD"
                                   
trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "American Fork River at mouth"] <- "American Fork River"
                                
trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "Unnamed flow at 4000 West @ mouth"] <- "4000 South Drain Spanish Fork"

trib_fac_sites_intersect$WS_Name[trib_fac_sites_intersect$MonitoringLocationName == 
                                   "JORDAN R AT UTAH L OUTLET U121 XING"] <- "Jordan River"

trib_fac_sites_wsds <- trib_fac_sites_intersect %>%
  ungroup() %>%
  select(MonitoringLocationIdentifier, OrganizationIdentifier:LongitudeMeasure, 
         SiteType:Shape_Area) %>%
  distinct() %>%
  arrange(WS_Name)
# write.csv(trib_fac_sites_wsds, file = "./Data/Processed/trib_fac_sites_initial.csv",
#           row.names = FALSE)

trib_fac_sites_counts <- trib_fac_sites_intersect %>%
  ungroup() %>%
  group_by(MonitoringLocationIdentifier, OrganizationIdentifier, OrganizationFormalName,
           MonitoringLocationName, MonitoringLocationTypeName, LatitudeMeasure,
           LongitudeMeasure, SiteType, OBJECTID_1, OBJECTID, TARGET_FID,
           Type, wsa_sqkm, WS_Name, Monitored_, WS_NAME_1, WS_NAME_12, 
           Shape_Leng, Shape_Le_1, Shape_Area) %>%
  tally() %>%
  ungroup() %>%
  select(MonitoringLocationIdentifier, n)

trib_fac_sites_SD <- read.csv("./Data/Processed/trib_fac_sites.csv")

trib_fac_sites_combined <- full_join(trib_fac_sites_SD, trib_fac_sites_counts)
# write.csv(trib_fac_sites_combined, file = "./Data/Processed/trib_fac_sites_counts.csv",
#           row.names = FALSE)

trib_fac_sites_wsds <- trib_fac_sites_wsds %>%
  full_join(., trib_fac_sites_counts)
# write.csv(trib_fac_sites_wsds, file = "./Data/Processed/trib_fac_sites_counts.csv",
#           row.names = FALSE)

trib_fac_sites_intersect_downstream <- trib_fac_sites_intersect %>%
  filter(MonitoringLocationIdentifier %in% 
           c("UTAHDWQ_WQX-4995312", # Currant Creek
             "UTAHDWQ_WQX-4995465", "WFWQC_UT-4995467", # Benjamin Slough
             "UTAHDWQ_WQX-5919910", "WFWQC_UT-4917712", # 4000 South Drain Spanish Fork
             "UTAHDWQ_WQX-4995578", "WFWQC_UT-4995575", # Spanish Fork River
             "UTAHDWQ_WQX-4996040", "WFWQC_UT-4996040", # Dry Creek - Spanish Fork
             "UTAHDWQ_WQX-4996042", # Provo Bay 3
             "UTAHDWQ_WQX-4996044", # Provo Bay 5
             "WFWQC_UT-4996100", "UTAHDWQ_WQX-4996100", "WFWQC_UT-4996096", # Hobble Creek
             "WFWQC_UT-4996536", "WFWQC_UT-4996540", "UTAHDWQ_WQX-4996540", # Mill Race
             "WFWQC_UT-4996680", "UTAHDWQ_WQX-4996680", # Provo River
             "UTAHDWQ_WQX-4995230", "WFWQC_UT-4995210", "UTAHDWQ_WQX-4995210", # Powell Slough Major
             "WFWQC_UT-4995075", "UTAHDWQ_WQX-4995120", # Lindon Drain 
             "WFWQC_UT-4995043", "UTAHDWQ_WQX-4995041", # Timp SSD
             "WFWQC_UT-4994958", "UTAHDWQ_WQX-4994960", # American Fork River
             "WFWQC_UT-4994948", "UTAHDWQ_WQX-4994950", #Lehi Spring Creek
             "UTAHDWQ_WQX-4994804", # Dry Creek - Saratoga
             "UTAHDWQ_WQX-4994792")) #Lake Mountain - Israel Canyon
unique(trib_fac_sites_intersect_downstream$WS_Name)

trib_fac_sites_intersect_downstream$SiteType[is.na(trib_fac_sites_intersect_downstream$SiteType)] <- "Unknown"

trib_fac_sites_downstream <- trib_fac_sites_intersect_downstream %>% 
  ungroup() %>%
  select(MonitoringLocationIdentifier, MonitoringLocationName, OrganizationIdentifier,
           MonitoringLocationTypeName, LatitudeMeasure, LongitudeMeasure, WS_Name) %>%
  distinct()


trib_fac_sites_downstream_sf <- st_as_sf(trib_fac_sites_downstream, coords = c("LongitudeMeasure", "LatitudeMeasure"),
                              crs = 4326, dim = "XY") #CRS = WGS84

                                                                                                                                
```

## Visualization
### Map
```{r, fig.height = 8, fig.width = 8, echo = FALSE, message = FALSE}
ggplot(wshds) +
  geom_sf(aes(fill = Monitored_)) +
  geom_sf(data = trib_fac_sites_sf, aes(color = SiteType),
          alpha = 0.5) +
  scale_color_viridis_d(option = "magma", end = 0.8, direction = -1) +
  scale_fill_manual(values = c("darkgray", "lightgray"))

ggplot(subset(wshds, Monitored_ == "YES")) +
  geom_sf() +
  geom_sf(data = trib_fac_sites_downstream_sf, aes(color = OrganizationIdentifier)) +
  facet_wrap(vars(WS_Name)) 

tm_shape(subset(wshds, Monitored_ == "YES")) +
  tm_polygons("wsa_sqkm")  +
  tm_facets(by = "WS_Name")

map.grid <- purrr::map(wshds_monitored$WS_Name,
           function(x) {
             ggplot() +
               geom_sf(data = filter(wshds_monitored, WS_Name == x)) +
               geom_sf(data = filter(trib_fac_sites_downstream_sf, WS_Name == x), 
                       aes(color = OrganizationIdentifier)) +
               scale_color_viridis_d(option = "magma", end = 0.8, begin = 0.2, direction = -1) +
               guides(fill = FALSE) +
               theme(legend.position = "none") +
               labs(title = x)
           })
plot_grid(plotlist = map.grid, label_size = 8)

ggplot(wshds) +
  geom_sf(aes(fill = Monitored_)) +
  geom_sf(data = trib_fac_sites_downstream_sf, aes(color = OrganizationIdentifier)) +
  labs(fill = "Monitored", color = "Organization") +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.7, direction = -1) +
  scale_fill_manual(values = c("darkgray", "lightgray")) +
  theme(legend.position = "top")

```


### Water Quality Time Series
```{r, fig.height = 8, fig.width = 8, echo = FALSE, message = FALSE}
# TN
ggplot(trib_fac_sites_intersect_downstream, aes(x = datetime, y = TN, shape = SiteType,
                                                color = OrganizationIdentifier)) +
  geom_point(alpha = 0.7, size = 2) +
  facet_wrap(vars(WS_Name), ncol = 3) +
  labs(x = "", y = "TN (mg/L)", shape = "Site Type", color = "Organization") +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.7, direction = -1) +
  theme(legend.position = "top")
  
# TDN
ggplot(trib_fac_sites_intersect_downstream, aes(x = datetime, y = TDN, shape = SiteType,
                                                color = OrganizationIdentifier)) +
  geom_point(alpha = 0.7, size = 2) +
  facet_wrap(vars(WS_Name), ncol = 3) +
  labs(x = "", y = "TDN (mg/L)", shape = "Site Type", color = "Organization") +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.7, direction = -1) +
  theme(legend.position = "top")

# PO4.t
ggplot(trib_fac_sites_intersect_downstream, aes(x = datetime, y = PO4.t, shape = SiteType,
                                                color = OrganizationIdentifier)) +
  geom_point(alpha = 0.7, size = 2) +
  facet_wrap(vars(WS_Name), ncol = 3) +
  labs(x = "", y = "Total PO4 (mg/L)", shape = "Site Type", color = "Organization") +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.7, direction = -1) +
  theme(legend.position = "top")

# PO4.d
ggplot(trib_fac_sites_intersect_downstream, aes(x = datetime, y = PO4.d, shape = SiteType,
                                                color = OrganizationIdentifier)) +
  geom_point(alpha = 0.7, size = 2) +
  facet_wrap(vars(WS_Name), ncol = 3) +
  labs(x = "", y = "Dissolved PO4 (mg/L)", shape = "Site Type", color = "Organization") +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.7, direction = -1) +
  theme(legend.position = "top")

# TOC
ggplot(trib_fac_sites_intersect_downstream, aes(x = datetime, y = TOC, shape = SiteType,
                                                color = OrganizationIdentifier)) +
  geom_point(alpha = 0.7, size = 2) +
  facet_wrap(vars(WS_Name), ncol = 3) +
  labs(x = "", y = "TOC (mg/L)", shape = "Site Type", color = "Organization") +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.7, direction = -1) +
  theme(legend.position = "top")

# DOC
ggplot(trib_fac_sites_intersect_downstream, aes(x = datetime, y = DOC, shape = SiteType,
                                                color = OrganizationIdentifier)) +
  geom_point(alpha = 0.7, size = 2) +
  facet_wrap(vars(WS_Name), ncol = 3) +
  labs(x = "", y = "DOC (mg/L)", shape = "Site Type", color = "Organization") +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.7, direction = -1) +
  theme(legend.position = "top")

```

### Stream Flow Time Series

```{r}
ggplot(test, aes(x = datetime, y = cfs)) +
  geom_point() +
  scale_y_log10() +
  facet_wrap(~MonitoringLocationName, drop = TRUE)
```


## Spare code

```{r, include = FALSE}
DmrFac <- read.csv("./Data/Processed/DmrFacilityInfo.csv")

Dmr_Sp <- st_as_sf(DmrFac,coords = c("dec_long", "dec_lat"),crs=4236)


```

