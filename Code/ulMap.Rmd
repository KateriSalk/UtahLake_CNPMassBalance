---
title: "ulMap"
author: "Sdaly"
date: "10/7/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Librarys

```{r}
library(wqTools)
library(sf)
library(leaflet)
library(dplyr)
library(ggplot2)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Import Shapefiles
##Watershed Boundary

```{r}
wshds <- read_sf("./Data/GIS/UL_subwshedsWGS84_v2.shp")
comp4489  <- read_sf("./Data/GIS/comp4489_wgs84.shp")
```

# Import Monitoring Locations
##WQP Monitoring locations
./Data/Processed/
```{r}
Data.WQP_Trib <- read.csv("./Data/Processed/ul_Tribdata_wqp_processed_2021-03-02.csv")
TribSites <- Data.WQP_Trib %>% distinct(MonitoringLocationIdentifier, MonitoringLocationName, MonitoringLocationTypeName, LatitudeMeasure,LongitudeMeasure)
write.csv(TribSites,file = "./Data/Processed/WQPTribSites.csv")
TribSites_as_sf <- st_as_sf(TribSites, coords = c("LongitudeMeasure", "LatitudeMeasure"), crs = 4326, dim = "XY") #CRS = WGS84


```

##Permitted Facilities - WQP

TODO - need to extract several sites from ul_facilitydata_wqp_processed_####-##-##.csv and append to TribData. sites = c("4996640","4996650","5919790","5919800","5919870","5919880","5919890",
"5919900","5919910")

```{r}
Data.WQP_Fac <- read.csv("./Data/Processed/ul_Facilitydata_wqp_processed.csv")
FacSites <- Data.WQP_Fac %>% distinct(MonitoringLocationIdentifier, MonitoringLocationName, MonitoringLocationTypeName, LatitudeMeasure,LongitudeMeasure)

FacSites_as_sf <- st_as_sf(FacSites, coords = c("LongitudeMeasure", "LatitudeMeasure"), crs = 4326, dim = "XY") #CRS = WGS84

```

## Combine sf files for Tributaries and WQP Permitted Facilities
```{r}
TribFacSites_as_sf <- rbind(TribSites_as_sf, FacSites_as_sf)

# collapse categories 
TribFacSites_as_sf <- TribFacSites_as_sf %>%
  mutate(SiteType = ifelse(MonitoringLocationTypeName %in% 
                  c("Canal Drainage", "Canal Irrigation", "Canal Transport"), "Canal", 
                ifelse(MonitoringLocationTypeName %in% c("River/Stream", "Stream", "Stream: Ditch"), "Stream",
                       ifelse(MonitoringLocationTypeName %in% c("Facility Industrial", "Facility Other"), "Facility", 
                              "Storm Sewer"))))

```

## Create separate datasets for each watershed
### Monitored Watersheds
```{r}

tribfacsites_intersect <- TribFacSites_as_sf %>%
  st_intersection(wshds)
```

### Unmonitored watersheds

#Permitted Facilities - DMR
```{r}
DmrFac <- read.csv("./Data/Processed/DmrFacilityInfo.csv")

Dmr_Sp <- st_as_sf(DmrFac,coords = c("dec_long", "dec_lat"),crs=4236)
```


#Build Map

##wqTools Git resources
baseMap()
findSites()
%>% addMarkers(data = FacSites, lng = ~LongitudeMeasure, lat = ~LatitudeMeasure) 

%>% addLayersControl(overlayGroups = c("WQP-Facility","DMR-Facility","WQP-Trib"),
    options = layersControlOptions(collapsed = FALSE)
  )

```{r}
ul_bbox <- st_bbox(wshds)
wsdMap <- baseMap() %>% 
  addMapResetButton() %>% 
  addMeasure(position = "topright", primaryLengthUnit = "feet", primaryAreaUnit = "acres") %>% 
  addTiles() %>% 
  addPolygons(data=wshds, weight = 1.5, color = "gray", opacity =1, label = ~paste(WS_Name, "--Monitored:", Monitored_,"--WSType",Type),group = "Subwatersheds") %>%
  addPolygons(data=comp4489, weight = 1.5, color = "blue", opacity =1,group = "Comp. Elevation") %>% 
  addCircleMarkers(data = FacSites, lng = ~LongitudeMeasure, lat = ~LatitudeMeasure, color = "", label = ~paste(MonitoringLocationIdentifier), group = "WQP-Facility") %>%
  addCircleMarkers(data = DmrFac, lng = ~dec_long, lat = ~dec_lat, color = "red", label = ~paste(CWPName), group = "DMR-Facility") %>%
  addCircleMarkers(data = TribSites, lng = ~LongitudeMeasure, lat = ~LatitudeMeasure, label = ~paste(MonitoringLocationIdentifier), group = "WQP-Trib") %>%
  fitBounds(ul_bbox[[1]],ul_bbox[[2]],ul_bbox[[3]],ul_bbox[[4]]) %>% 
addLayersControl(position ="topright",
			baseGroups = c("World topo","USGS topo", "Hydrography", "Satellite"),overlayGroups = c("Subwatersheds","DMR-Facility", "WQP-Facility","WQP-Trib", "Comp. Elevation"),
			options = leaflet::layersControlOptions(collapsed = TRUE, autoZIndex=FALSE)) 
wsdMap
```

```{r}
ggplot(wshds) +
  geom_sf(aes(fill = Monitored_)) +
  geom_sf(data = TribFacSites_as_sf, aes(color = SiteType),
          alpha = 0.5) +
  #geom_sf(data = Dmr_Sp, color = "blue") +
  scale_color_viridis_d(option = "magma", end = 0.8, direction = -1) +
  scale_fill_manual(values = c("darkgray", "lightgray"))
```

